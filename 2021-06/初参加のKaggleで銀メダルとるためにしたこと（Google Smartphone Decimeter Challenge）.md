solutionは[こちら](https://noleff.hatenablog.com/entry/2021/08/10/190100)

<br>
# はじめに

先日終了したGoogle Smartphone Decimeter Challenge（通称outdoorコンペ）に参加し、銀メダル（34位/810teams）をとることができました。  
Kaggle初参加でしたが、相方の後輩とえっちらほっちらと蛇行しながらも、前に進めることができた結果が実ったのだと思っています。  
outdoorコンペの振り返りとともに、約2ヶ月間何をしたかをまとめていきたいと思います。

[https://www.kaggle.com/c/google-smartphone-decimeter-challenge/overview:embed:cite]


<br>
# outdoorコンペ概要

スマートフォン（Android）から得られるデータから、位置（緯度・経度）を推定するコンペでした。  
車にスマートフォンを固定し、データを集めるとともに、車の後部にアンテナを取り付け、それをground truthとしていました。

[f:id:Noleff:20210810132522p:plain]

舞台はアメリカ、シリコンバレー！    （世界の大概のものはここにあるやん、となるらしい）

[f:id:Noleff:20210810123642p:plain]

<br>
データは主に、以下のものが与えられていました。

1. GNSS関連のデータ
2. IMU関連のデータ
3. ホストが用意したベースラインとなるデータ
4. ホストが用意したGNSS関連のデータから分析しやすいように派生されたデータ

<br>
# 取り組み

- 毎週日曜日にミーティングをし、進捗報告
- Notionでタスク管理
- 対面以外はSlackで情報共有

<br>
#### 6月

与えられたデータを整形し、中間データとして吐き出すプログラムを書くだけでほぼ終わりました。  
本当に右も左もわからず、

「GNSSってなんだ？　GPSの親戚か？」  
「ふむふむ、GNSSの中にGPSがあるのね、初知り。他にはGalileoや北斗とかあるらしい。何それかっこいい」  

と初歩の初歩からさっぱりわかりませんでした。

さらに、与えられたGNSSデータのカラムもちんぷんかんぷんで、

「millisSinceGpsEpochって指つりそう……。は？　utcTimeMillis？　うるう秒？」  
「これ結合しようにも、millisSinceGpsEpoch完全一致してないやん。え？　merge_asof……だと……？」  

と、別ファイルにわかれているデータの時間の整合性をとることや結合自体に苦戦してました。

[f:id:Noleff:20210810141339p:plain]

そんなこんなで一ヶ月があった言う間に過ぎました。  
二人共、6月末と7月頭に学会発表があったということもあり、まだ全力で取り組めていなかった感がありました。

<br>
#### 7月

このままではヤバいなとなり、Kaggle内のCodeとDiscussionを一通り漁りました。  
そこで気がついたのは、後処理に関連する投稿が多かったことです。  
outdoorコンペの前にindoorコンペというものがあり、そのコンペでは後処理が有効であったことから、ホストが用意したベースラインのデータをもとに、後処理をする取り組みが多くありました。

現状、ほとんど何もできていない以上、これらの後処理を実装するところから始めようとなりました。  
これが7月1日の話です。

[f:id:Noleff:20210810141351p:plain]

そこからは、怒涛の後処理実装と、それらをどう組み合わせるかを検討していました。  
LBに投稿することで精度を比較したり、trainデータに対して後処理した結果とground truthの距離を計算し、精度向上に寄与しているかを確認したりしていました。

しかし、それらにも限界がありました。  
ベースラインを主軸にしているため、ベースラインが悪ければ、どんなに後処理で補正しようにも限度というものがあります。  
なお、この時点でGNSS関連の知識は依然としてゼロでした。

そこで後処理は相方に任せ、私はIMUデータのアプローチを開始しました。  
IMU関連のデータは研究で扱っているため、普段から馴染みのあることもあり、さっぱりわからなかったGNSS関連のデータとにらめっこするよりも、現実的だと判断しました。  
ただし、金メダルをとっている上位陣の解法をみるに、このにらめっこがなければ上位にはいけなかった、ということもまた事実です。ただ、振り返りを書いている今、この判断が間違っているとは思いません。結果論ですが。

一言で言うと、**位置を推定するコンペで、GNSS関連のデータを捨てるという決断をしたことになります。**

結果、IMUから位置を推定するアプローチは銅圏を出たり入ったりしていた状態から、銀圏まで一気に躍り出ることができました。


[https://twitter.com/8_furu8/status/1419597239190650881?s=20:embed]


[https://twitter.com/8_furu8/status/1421889179353456644?s=20:embed]


<br>
#### 8月

はてさて、そんなこんなでラストスパート8月です。  
一週間弱しかありませんでしたが、Notionにラストスパートという項目を作り、「この一週間Kaggle以外でコーディングしねぇ」くらいには気合入れてやってました。

やったことは以下になります。

1. moving or not   
車が止まっているとき精度が悪いということから、車が動いているかどうか二値分類モデルで判定し、止まっているときの緯度・経度を時系列で最も近い値で補正

2. スタッキング  
IMUから緯度経度推定をLightGBMだけでなく、ランダムフォレストとRidge回帰でも推定してスタッキング

3. アンサンブル  
IMUから推定しした緯度経度とベースラインから後処理した緯度経度の加重平均

<br>
どう考えても、時間は足りませんでした(汗)。  
アンサンブルも半ば投げやりでやっていた感が否めません。  
この辺りの知見はそれほどなく、本来であればLBやCVとを比較しながら検討すべき部分であるはずですが、実際LBに出せたのはラスト2日間だけでした。  
ぶっちゃけ、アンサンブルするよりも、ランダムフォレスト単体の方がprivateのLBは良かったのですが、それも27、28位なので、ほぼ変わりませんでしたね。  

# 反省点

1.  序盤（6月）はダレていた  
コンペ終了までまだ時間があると、研究を初め、Kaggle以外のことに時間を割いていました。進め方がわからず、ふわふわとしていた時間が長かったため、次Kaggleに挑戦するときは、序盤から上位に行けるよう頑張りたいところです。

2. 予定通りに進んでいない  
Notionでタスク管理するところから初めたのですが、勝手がわからず、全然予定通り進めることができませんでした。アンサンブルに時間が足りなくなったのも、予定のしわ寄せが原因です。  
アンサンブルの検証にかかる時間コストを見積もれなかったこともいけませんでした。

3. publicのLBに頼りすぎた  
publicLBでは22位でした。どのみち銀圏ですが、そこからprivateLBで34位まで落ちているので、正直publicにフィッティングし過ぎた感があります。学習系は交差検証をしていましたが、後処理系はすべて同じ順番で後処理していたため、後処理の順序を変えるなどしてバリエーション増やせば良かったのでしょうか？　

<br>
# まとめ

なんとかありつけた銀メダル、でした。  
東京オリンピックも日本最多メダル数ということで、どこかプレミア感があります。少なくとも初めてとったKaggleのメダルはいつか、という質問には何年経っても答えられるでしょう。（オリンピックまったく見ておりませんが）。  
夏休みは研究にまたシフトするので、次にコンペ参加はいつになるやらですね。  
卒業までにはもう一枚メダル取りたい気持ちはあるので、どこかで頑張りたいところです。